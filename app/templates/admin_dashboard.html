<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ALGO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=League+Spartan:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/admin_dashboard.css') }}">
</head>

<body>
    <!-- HEADER -->
    <header>
        <div class="container">
            <nav>
                <a href="#" class="logo" id="home-link">algo</a>
                <ul class="nav-links">
                    <li><a href="{{ url_for('home')}}" class="active" data-section="home">Home</a></li>
                    <li><a href="#" data-section="browse">Browse Alumni</a></li>
                    <li><a href="#" data-section="jobs">Job Board</a></li>
                    <li><a href="#" data-section="events">Events</a></li>
                    <li><a href="{{ url_for('contact') }}" class="active">Contact Us</a></li>
                    <li><a href="{{ url_for('about') }}">About Us</a></li>
                    <li><a href="{{ url_for('login') }}">Login</a></li>
                    <li><a href="{{ url_for('register') }}" class="nav-signup">Sign Up</a></li>
                </ul>
                <div class="hamburger">
                    <div class="line1"></div>
                    <div class="line2"></div>
                    <div class="line3"></div>
                </div>
            </nav>
        </div>
    </header>

    <!-- ADMIN DASHBOARD -->
    <section class="admin-section">
        <div class="container">
            <div class="admin-header">
                <div class="admin-welcome">
                    <h1><i class="fas fa-shield-alt"></i> Admin Dashboard</h1>
                    <p>Manage verification requests and college administration</p>
                </div>
                <div class="admin-actions">
                    <a href="{{ url_for('create_community') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Create Community
                    </a>
                </div>
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="pending-count">{{ pending_count }}</h3>
                            <p>Pending Requests</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3>{{ total_verified }}</h3>
                            <p>Verified Users</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VERIFICATION REQUESTS -->
            <div class="admin-content">
                <div class="section-header">
                    <h2><i class="fas fa-user-check"></i> Pending Verification Requests</h2>
                    <div class="section-actions">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="student">Students</button>
                        <button class="filter-btn" data-filter="alumni">Alumni</button>
                        <button class="filter-btn" data-filter="staff">Staff</button>
                    </div>
                </div>

                <div class="requests-grid" id="requests-grid">
                    {% if pending_requests %}
                        {% for request in pending_requests %}
                        <div class="request-card" data-role="{{ request.requested_role }}">
                            <div class="request-header">
                                <div class="user-info">
                                    <div class="user-avatar">
                                        {% if request.pfp_path %}
                                            <img src="{{ request.pfp_path }}" alt="{{ request.username }}">
                                        {% else %}
                                            <img src="https://ui-avatars.com/api/?name={{ request.username|replace(' ', '+') }}&background=667eea&color=fff&size=50" alt="{{ request.username }}">
                                        {% endif %}
                                    </div>
                                    <div class="user-details">
                                        <h3>{{ request.username }}</h3>
                                        <p class="user-email">{{ request.email }}</p>
                                        <span class="role-badge {{ request.requested_role }}">{{ request.requested_role.title() }}</span>
                                    </div>
                                </div>
                                <div class="request-date">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>{{ request.created_at.strftime('%b %d, %Y') }}</span>
                                </div>
                            </div>
                            <div class="request-details">
                                <div class="detail-item">
                                    <strong>University:</strong> {{ request.community_name or 'Not specified' }}
                                </div>
                                {% if request.department %}
                                <div class="detail-item">
                                    <strong>Department:</strong> {{ request.department }}
                                </div>
                                {% endif %}
                                {% if request.graduation_year %}
                                <div class="detail-item">
                                    <strong>Graduation Year:</strong> {{ request.graduation_year }}
                                </div>
                                {% endif %}
                                {% if request.verification_id %}
                                <div class="detail-item">
                                    <strong>{% if request.requested_role == 'student' %}Student ID{% elif request.requested_role == 'alumni' %}Alumni ID{% else %}Employee ID{% endif %}:</strong> {{ request.verification_id }}
                                </div>
                                {% endif %}
                                {% if request.message %}
                                <div class="detail-item">
                                    <strong>Message:</strong> {{ request.message }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="request-actions">
                                <button class="btn-approve" onclick="handleRequest('{{ request.user_id }}', 'approve')">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn-reject" onclick="handleRequest('{{ request.user_id }}', 'reject')">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                <!-- Empty state when no requests -->
                {% if not pending_requests %}
                <div class="empty-state" id="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>All caught up!</h3>
                    <p>No pending verification requests at the moment.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- REVIEW MODAL -->
    <div class="modal-overlay" id="reviewModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Review Request</h3>
                <button class="modal-close" onclick="closeReviewModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <form id="reviewForm" method="POST">
                    <input type="hidden" id="requestId" name="request_id">
                    <input type="hidden" id="action" name="action">
                    
                    <div class="form-group">
                        <label for="reviewNotes">Review Notes (Optional)</label>
                        <textarea id="reviewNotes" name="review_notes" rows="4" 
                                  placeholder="Add any notes for the user..."></textarea>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeReviewModal()">Cancel</button>
                        <button type="submit" class="btn" id="submitBtn">Confirm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <span class="logo">algo</span>
                    <p>Connecting students and alumni for career growth and opportunities.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://x.com/algo_pancho" target="_blank"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.instagram.com/algo.pancho?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==" target="_blank"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                <div class="footer-links">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#" data-section="home">Home</a></li>
                        <li><a href="#" data-section="browse">Browse Alumni</a></li>
                        <li><a href="#" data-section="jobs">Job Board</a></li>
                        <li><a href="#" data-section="events">Events</a></li>
                        <li><a href="{{ url_for('about') }}">About Us</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h3>Resources</h3>
                    <ul>
                        <li><a href="#">Blog</a></li>
                        <li><a href="#">Career Tips</a></li>
                        <li><a href="#">Success Stories</a></li>
                        <li><a href="#">FAQ</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h3>Support</h3>
                    <ul>
                        <li><a href="#">Help Center</a></li>
                        <li><a href="{{ url_for('contact') }}">Contact Us</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
            </div>
            <p class="copyright">&copy; 2025 ALGO - Alumni Go. All rights reserved.</p>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/admin_dashboard.js') }}"></script>
    <script>
        // Filter requests by role
        const filterBtns = document.querySelectorAll('.filter-btn');
        const requestsGrid = document.getElementById('requests-grid');

        filterBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const role = e.target.dataset.filter;
                const requests = requestsGrid.children;

                requests.forEach(request => {
                    if (role === 'all') {
                        request.style.display = 'block';
                    } else if (request.dataset.role === role) {
                        request.style.display = 'block';
                    } else {
                        request.style.display = 'none';
                    }
                });

                // Toggle active class
                filterBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === role);
                });
            });
        });

        // Handle approve/reject requests
        async function handleRequest(userId, action) {
            const button = event.target.closest('button');
            const requestCard = button.closest('.request-card');
            
            // Disable buttons during request
            const approveBtn = requestCard.querySelector('.btn-approve');
            const rejectBtn = requestCard.querySelector('.btn-reject');
            approveBtn.disabled = true;
            rejectBtn.disabled = true;
            
            try {
                const response = await fetch('/api/handle_verification_request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        action: action
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    alert(`Request ${action}d successfully!`);
                    
                    // Remove the request card from the UI
                    requestCard.style.transition = 'opacity 0.3s ease';
                    requestCard.style.opacity = '0';
                    setTimeout(() => {
                        requestCard.remove();
                        
                        // Update pending count
                        const pendingCountEl = document.getElementById('pending-count');
                        if (pendingCountEl) {
                            const currentCount = parseInt(pendingCountEl.textContent);
                            pendingCountEl.textContent = Math.max(0, currentCount - 1);
                        }
                        
                        // Check if no more requests
                        const remainingRequests = document.querySelectorAll('.request-card');
                        if (remainingRequests.length === 0) {
                            document.getElementById('requests-grid').innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <h3>All Caught Up!</h3>
                                    <p>No pending verification requests at the moment.</p>
                                </div>
                            `;
                        }
                    }, 300);
                } else {
                    alert(`Error: ${result.message}`);
                    // Re-enable buttons on error
                    approveBtn.disabled = false;
                    rejectBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error handling request:', error);
                alert('An error occurred. Please try again.');
                // Re-enable buttons on error
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
            }
        }
    </script>
</body>
</html>